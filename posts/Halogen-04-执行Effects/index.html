<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Halogen-04-执行Effects" /><meta name="author" content="purescript-halogen" /><meta property="og:locale" content="en" /><meta name="description" content="Performing Effects" /><meta property="og:description" content="Performing Effects" /><link rel="canonical" href="/posts/Halogen-04-%E6%89%A7%E8%A1%8CEffects/" /><meta property="og:url" content="/posts/Halogen-04-%E6%89%A7%E8%A1%8CEffects/" /><meta property="og:site_name" content="Lovelace" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-01-02T11:04:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Halogen-04-执行Effects" /><meta name="google-site-verification" content="hYrEuDXdYFrLw9klfbDC2ltqWoXRXTNHWmgf9bgO838" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"purescript-halogen"},"headline":"Halogen-04-执行Effects","dateModified":"2022-01-02T11:04:00+08:00","datePublished":"2022-01-02T11:04:00+08:00","description":"Performing Effects","url":"/posts/Halogen-04-%E6%89%A7%E8%A1%8CEffects/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/Halogen-04-%E6%89%A7%E8%A1%8CEffects/"},"@context":"https://schema.org"}</script><title>Halogen-04-执行Effects | Lovelace</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Lovelace"><meta name="application-name" content="Lovelace"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script> var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "https://hm.baidu.com/hm.js?d0140067dd798ddd08fa1dfeecc191bb"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); })(); </script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Lovelace</a></div><div class="site-subtitle font-italic">所有的善恶都是我，良心一路走来依旧清澈鲜活...</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/haskell-monad" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['haskell.lisp','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Halogen-04-执行Effects</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Halogen-04-执行Effects</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/purescript-halogen/purescript-halogen/blob/master/docs/guide/03-Performing-Effects.md">purescript-halogen</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" date="2022-01-02T11:04:00+08:00" data-toggle="tooltip" data-placement="bottom" title="Sun, Jan 2, 2022, 11:04 AM +0800" >Jan 2, 2022</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3085 words"> <em>17 min</em> read</span></div></div></div><div class="post-content"><h3 id="performing-effects">Performing Effects <a href="#performing-effects" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p>到目前为止，我们已经涵盖了很多领域。您知道如何编写<code class="language-plaintext highlighter-rouge">Halogen HTML</code>。您可以定义响应用户交互的组件并按类型对组件的每个部分进行建模, 有了这个基础，我们就可以在编写应用程序时继续使用另一个重要的工具: 执行<code class="language-plaintext highlighter-rouge">effects</code>。</p><p>在本章中，我们将通过两个示例探索如何在您的组件中执行<code class="language-plaintext highlighter-rouge">effects</code>: 生成随机数并发出<code class="language-plaintext highlighter-rouge">HTTP</code>请求。一旦您知道如何执行<code class="language-plaintext highlighter-rouge">effects</code>，您就可以很好地掌握<code class="language-plaintext highlighter-rouge">Halogen</code>基础知识.</p><p>在我们开始之前，重要的是要知道您只能在评估期间执行<code class="language-plaintext highlighter-rouge">effects</code>，例如像<code class="language-plaintext highlighter-rouge">handleAction</code>这样使用<code class="language-plaintext highlighter-rouge">HalogenM</code>类型的函数. 但是您无法在生成初始状态或渲染期间执行<code class="language-plaintext highlighter-rouge">effects</code>。由于您只能在<code class="language-plaintext highlighter-rouge">HalogenM</code>中执行<code class="language-plaintext highlighter-rouge">effects</code>，因此在深入研究示例之前，让我们简要了解一下它的更多信息。</p><h4 id="halogenm类型">HalogenM类型 <a href="#halogenm类型" class="anchor"><i class="fas fa-hashtag"></i></a></h4></h4><p>如果您还记得上一章的内容，<code class="language-plaintext highlighter-rouge">handleAction</code>函数会返回一个名为<code class="language-plaintext highlighter-rouge">HalogenM</code>的类型。这是我们写的<code class="language-plaintext highlighter-rouge">handleAction</code>:</p><pre><code class="language-purescript">handleAction :: forall output m. Action -&gt; HalogenM State Action () output m Unit
</code></pre><p><code class="language-plaintext highlighter-rouge">HalogenM</code>是<code class="language-plaintext highlighter-rouge">Halogen</code>的关键部分，通常称为<code class="language-plaintext highlighter-rouge">eval</code>单子。这个<code class="language-plaintext highlighter-rouge">monad</code>启用了<code class="language-plaintext highlighter-rouge">Halogen</code>特性，如状态、分叉线程、开始订阅等。但它非常有限，仅与<code class="language-plaintext highlighter-rouge">Halogen</code>特定的性质有关。事实上，<code class="language-plaintext highlighter-rouge">Halogen</code>组件没有内置的<code class="language-plaintext highlighter-rouge">effects</code>机制！</p><p>相反，<code class="language-plaintext highlighter-rouge">Halogen</code>允许您选择要在组件中与<code class="language-plaintext highlighter-rouge">HalogenM</code>一起使用的<code class="language-plaintext highlighter-rouge">monad</code>。您可以访问<code class="language-plaintext highlighter-rouge">HalogenM</code>的所有功能以及您选择的<code class="language-plaintext highlighter-rouge">monad</code>支持的任何功能. 这用类型参数<code class="language-plaintext highlighter-rouge">m</code>表示，它代表<code class="language-plaintext highlighter-rouge">monad</code>。</p><p>仅使用<code class="language-plaintext highlighter-rouge">Halogen</code>特定性质的组件可以让此类型参数保持打开状态。例如，我们的计数器只更新状态。但是执行<code class="language-plaintext highlighter-rouge">effects</code>的组件可以使用 <code class="language-plaintext highlighter-rouge">Effect</code>或<code class="language-plaintext highlighter-rouge">Aff monad</code>，或者您可以提供自己的自定义<code class="language-plaintext highlighter-rouge">monad</code>。</p><p>这个<code class="language-plaintext highlighter-rouge">handleAction</code>可以使用来自<code class="language-plaintext highlighter-rouge">HalogenM</code>的函数，比如<code class="language-plaintext highlighter-rouge">modify_</code>，也可以使用来自<code class="language-plaintext highlighter-rouge">Effect</code>的<code class="language-plaintext highlighter-rouge">effectful</code>函数:</p><pre><code class="language-purescript">handleAction :: forall output. Action -&gt; HalogenM State Action () output Effect Unit
</code></pre><p>这个可以使用来自<code class="language-plaintext highlighter-rouge">HalogenM</code>的函数以及来自<code class="language-plaintext highlighter-rouge">Aff</code>的<code class="language-plaintext highlighter-rouge">effectful</code>函数:</p><pre><code class="language-purescript">handleAction :: forall output. Action -&gt; HalogenM State Action () output Aff Unit
</code></pre><p>在<code class="language-plaintext highlighter-rouge">Halogen</code>中更常见的是对类型参数<code class="language-plaintext highlighter-rouge">m</code>使用约束来描述<code class="language-plaintext highlighter-rouge">monad</code>可以做什么，而不是选择特定的<code class="language-plaintext highlighter-rouge">monad</code>, 这允许您随着应用程序的增长将多个<code class="language-plaintext highlighter-rouge">monad</code>混合在一起。例如，大多数<code class="language-plaintext highlighter-rouge">Halogen</code>应用程序将通过以下类型签名使用来自<code class="language-plaintext highlighter-rouge">Aff</code>的函数:</p><pre><code class="language-purescript">handleAction :: forall output m. MonadAff m =&gt; Action -&gt; HalogenM State Action () output m Unit
</code></pre><p>这让您可以完成硬编码<code class="language-plaintext highlighter-rouge">Aff</code>类型所做的一切，但也可以让您混合其他约束。</p><p>最后一件事: 当你为你的组件选择一个<code class="language-plaintext highlighter-rouge">monad</code>时，它会出现在你的<code class="language-plaintext highlighter-rouge">HalogenM</code>类型、你的<code class="language-plaintext highlighter-rouge">Component</code>类型中，如果你正在使用子组件，那么它会出现在你的<code class="language-plaintext highlighter-rouge">ComponentHTML</code>类型中:</p><pre><code class="language-purescript">component :: forall query input output m. MonadAff m =&gt; H.Component query input output m

handleAction :: forall output m. MonadAff m =&gt; Action -&gt; HalogenM State Action () output m Unit

-- We aren't using child components, so we don't have to use the constraint here, but
-- we'll learn about when it's required in the parent &amp; child components chapter.
render :: forall m. State -&gt; H.ComponentHTML Action () m
</code></pre><h3 id="一个effect例子-随机数">一个Effect例子: 随机数 <a href="#一个effect例子-随机数" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p>让我们创建一个新的简单组件，每次单击按钮时都会生成一个新的随机数。在您阅读示例时，请注意它如何使用与我们用于编写计数器的相同类型和函数。随着时间的推移，您将习惯于快读<code class="language-plaintext highlighter-rouge">Halogen</code>组件的状态、动作和其他类型，以了解其功能的要点，并熟悉标准函数，如<code class="language-plaintext highlighter-rouge">initialState</code>、<code class="language-plaintext highlighter-rouge">render</code> 和 <code class="language-plaintext highlighter-rouge">handleAction</code>。</p><blockquote><p>您可以将此示例粘贴到<a href="https://try.purescript.org/">Try Purescript</a>中以交互方式探索它。您还可以在此存储库的示例目录中查看并运行<a href="https://github.com/purescript-halogen/purescript-halogen/tree/master/examples/effects-effect-random">完整的示例代码</a>。</p></blockquote><p>请注意，我们没有在我们的<code class="language-plaintext highlighter-rouge">initialState</code>或<code class="language-plaintext highlighter-rouge">render</code>函数中执行任何<code class="language-plaintext highlighter-rouge">effects</code> – 例如，我们将我们的状态初始化为<code class="language-plaintext highlighter-rouge">Nothing</code>而不是为我们的初始状态生成一个随机数 —— 但是我们可以在我们的<code class="language-plaintext highlighter-rouge">handleAction</code>函数(使用<code class="language-plaintext highlighter-rouge">HalogenM</code>类型)中自由地执行<code class="language-plaintext highlighter-rouge">effects</code>。</p><pre><code class="language-purescript">module Main where

import Prelude

import Data.Maybe (Maybe(..), maybe)
import Effect (Effect)
import Effect.Class (class MonadEffect)
import Effect.Random (random)
import Halogen as H
import Halogen.Aff (awaitBody, runHalogenAff)
import Halogen.HTML as HH
import Halogen.HTML.Events as HE
import Halogen.VDom.Driver (runUI)

main :: Effect Unit
main = runHalogenAff do
  body &lt;- awaitBody
  runUI component unit body

type State = Maybe Number

data Action = Regenerate

component :: forall query input output m. MonadEffect m =&gt; H.Component query input output m
component =
  H.mkComponent
    { initialState
    , render
    , eval: H.mkEval $ H.defaultEval { handleAction = handleAction }
    }

initialState :: forall input. input -&gt; State
initialState _ = Nothing

render :: forall m. State -&gt; H.ComponentHTML Action () m
render state = do
  let value = maybe "No number generated yet" show state
  HH.div_
    [ HH.h1_
        [ HH.text "Random number" ]
    , HH.p_
        [ HH.text ("Current value: " &lt;&gt; value) ]
    , HH.button
        [ HE.onClick \_ -&gt; Regenerate ]
        [ HH.text "Generate new number" ]
    ]

handleAction :: forall output m. MonadEffect m =&gt; 
    Action -&gt; 
    H.HalogenM State Action () output m Unit
handleAction = case _ of
  Regenerate -&gt; do
    newNumber &lt;- H.liftEffect random
    H.modify_ \_ -&gt; Just newNumber
</code></pre><p>如您所见，执行<code class="language-plaintext highlighter-rouge">effects</code>的组件与不执行<code class="language-plaintext highlighter-rouge">effects</code>的组件没有太大区别！我们只做了两件事:</p><ul><li>我们为组件和<code class="language-plaintext highlighter-rouge">handleAction</code>函数的<code class="language-plaintext highlighter-rouge">m</code>类型参数添加了<code class="language-plaintext highlighter-rouge">MonadEffect</code>约束. 我们的<code class="language-plaintext highlighter-rouge">render</code>函数不需要约束，因为我们没有任何子组件。<li>我们实际上第一次使用了一个<code class="language-plaintext highlighter-rouge">effect</code>: <code class="language-plaintext highlighter-rouge">random</code>函数，它来自<code class="language-plaintext highlighter-rouge">Effect.Random</code>。</ul><p>让我们再分解一下这个<code class="language-plaintext highlighter-rouge">effect</code>。</p><pre><code class="language-purescript">--                          [1]
handleAction :: forall output m. MonadEffect m =&gt; 
        Action -&gt; 
        H.HalogenM State Action () output m Unit
handleAction = case _ of
  Regenerate -&gt; do
    newNumber &lt;- H.liftEffect random -- [2]
    H.modify_ \_ -&gt; Just newNumber   -- [3]
</code></pre><ul><li>我们已经限制了我们的<code class="language-plaintext highlighter-rouge">m</code>类型参数说我们支持任何<code class="language-plaintext highlighter-rouge">monad</code>，只要那个<code class="language-plaintext highlighter-rouge">monad</code>支持<code class="language-plaintext highlighter-rouge">MonadEffect</code>. 这是”我们需要能够在我们的评估代码中使用<code class="language-plaintext highlighter-rouge">Effect</code>函数”的另一种说法。<li>随机函数的类型为<code class="language-plaintext highlighter-rouge">Effect Number</code>。但是我们不能直接使用它：我们的组件不支持<code class="language-plaintext highlighter-rouge">Effect</code>而是支持任何<code class="language-plaintext highlighter-rouge">monad m</code>，只要该<code class="language-plaintext highlighter-rouge">monad</code>可以从<code class="language-plaintext highlighter-rouge">Effect</code>运行<code class="language-plaintext highlighter-rouge">effects</code>. 这是一个细微的区别，但最终我们要求<code class="language-plaintext highlighter-rouge">random</code>函数的类型为<code class="language-plaintext highlighter-rouge">MonadEffect m =&gt; m Number</code>而不是直接为 <code class="language-plaintext highlighter-rouge">Effect</code>. 幸运的是，我们可以使用<code class="language-plaintext highlighter-rouge">LiftEffect</code>函数将任何<code class="language-plaintext highlighter-rouge">Effect</code>类型转换为<code class="language-plaintext highlighter-rouge">MonadEffect m =&gt; m</code>。这是<code class="language-plaintext highlighter-rouge">Halogen</code>中的常见模式，因此如果您使用<code class="language-plaintext highlighter-rouge">MonadEffect</code>，请记住<code class="language-plaintext highlighter-rouge">liftEffect</code>。<li><code class="language-plaintext highlighter-rouge">modify_</code>函数让你更新状态，它直接来自带有其他状态更新功能的<code class="language-plaintext highlighter-rouge">HalogenM</code>。在这里，我们使用它来将新的随机数写入我们的状态。</ul><p>这是一个很好的示例，说明您可以如何自由地将<code class="language-plaintext highlighter-rouge">Effect</code>中的<code class="language-plaintext highlighter-rouge">effects</code>与特定于<code class="language-plaintext highlighter-rouge">Halogen</code>的函数(如<code class="language-plaintext highlighter-rouge">modify_</code>)交织在一起。让我们再做一次，这次使用<code class="language-plaintext highlighter-rouge">Aff monad</code>来实现异步效果。</p><h3 id="一个aff例子-http-requests">一个Aff例子: HTTP Requests <a href="#一个aff例子-http-requests" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p>从<code class="language-plaintext highlighter-rouge">Internet</code>上的其他地方获取信息是很常见的。例如，假设我们想使用<code class="language-plaintext highlighter-rouge">GitHub</code>的<code class="language-plaintext highlighter-rouge">API</code>来获取用户。我们将使用<a href="https://pursuit.purescript.org/packages/purescript-affjax">affjax</a>包来发出我们的请求, 它本身依赖于<code class="language-plaintext highlighter-rouge">Aff monad</code>来实现异步效果。</p><p>不过，这个例子更有趣: 我们还将使用<code class="language-plaintext highlighter-rouge">preventDefault</code>函数来防止表单提交刷新页面，该页面在<code class="language-plaintext highlighter-rouge">Effect</code>中运行。这意味着我们的示例展示了如何将不同的<code class="language-plaintext highlighter-rouge">effects</code>(<code class="language-plaintext highlighter-rouge">Effect</code>和<code class="language-plaintext highlighter-rouge">Aff</code>)与<code class="language-plaintext highlighter-rouge">Halogen</code>函数(<code class="language-plaintext highlighter-rouge">HalogenM</code>)交织在一起。</p><blockquote><p>与<code class="language-plaintext highlighter-rouge">Random</code>示例一样，您可以将此示例粘贴到<a href="https://try.purescript.org/">Try Purescript</a>中以交互方式探索它。您还可以在此存储库的<code class="language-plaintext highlighter-rouge">examples</code>目录中查看并运行<a href="https://github.com/purescript-halogen/purescript-halogen/tree/master/examples/effects-aff-ajax">完整的示例代码</a>.</p></blockquote><p>这个组件定义应该看起来很熟悉。我们定义我们的<code class="language-plaintext highlighter-rouge">State</code>和<code class="language-plaintext highlighter-rouge">Action</code>类型并实现我们的<code class="language-plaintext highlighter-rouge">initialState</code>、<code class="language-plaintext highlighter-rouge">render</code>和<code class="language-plaintext highlighter-rouge">handleAction</code>函数. 我们将它们组合到我们的组件规范中，并将它们变成一个有效的组件<code class="language-plaintext highlighter-rouge">H.mkComponent</code>。</p><p>再次注意，我们的<code class="language-plaintext highlighter-rouge">effects</code>集中在<code class="language-plaintext highlighter-rouge">handleAction</code>函数中，并且在构造初始状态或渲染<code class="language-plaintext highlighter-rouge">Halogen HTML</code>时没有执行任何<code class="language-plaintext highlighter-rouge">effects</code>。</p><pre><code class="language-purescript">module Main where

import Prelude

import Affjax as AX
import Affjax.ResponseFormat as AXRF
import Data.Either (hush)
import Data.Maybe (Maybe(..))
import Effect (Effect)
import Effect.Aff.Class (class MonadAff)
import Halogen as H
import Halogen.Aff (awaitBody, runHalogenAff)
import Halogen.HTML as HH
import Halogen.HTML.Events as HE
import Halogen.HTML.Properties as HP
import Halogen.VDom.Driver (runUI)
import Web.Event.Event (Event)
import Web.Event.Event as Event

main :: Effect Unit
main = runHalogenAff do
  body &lt;- awaitBody
  runUI component unit body

type State =
  { loading :: Boolean
  , username :: String
  , result :: Maybe String
  }

data Action
  = SetUsername String
  | MakeRequest Event

component :: forall query input output m. MonadAff m =&gt; H.Component query input output m
component =
  H.mkComponent
    { initialState
    , render
    , eval: H.mkEval $ H.defaultEval { handleAction = handleAction }
    }

initialState :: forall input. input -&gt; State
initialState _ = { loading: false, username: "", result: Nothing }

render :: forall m. State -&gt; H.ComponentHTML Action () m
render st =
  HH.form
    [ HE.onSubmit \ev -&gt; MakeRequest ev ]
    [ HH.h1_ [ HH.text "Look up GitHub user" ]
    , HH.label_
        [ HH.div_ [ HH.text "Enter username:" ]
        , HH.input
            [ HP.value st.username
            , HE.onValueInput \str -&gt; SetUsername str
            ]
        ]
    , HH.button
        [ HP.disabled st.loading
        , HP.type_ HP.ButtonSubmit
        ]
        [ HH.text "Fetch info" ]
    , HH.p_
        [ HH.text $ if st.loading then "Working..." else "" ]
    , HH.div_
        case st.result of
          Nothing -&gt; []
          Just res -&gt;
            [ HH.h2_
                [ HH.text "Response:" ]
            , HH.pre_
                [ HH.code_ [ HH.text res ] ]
            ]
    ]

handleAction :: forall output m. MonadAff m =&gt; Action -&gt; H.HalogenM State Action () output m Unit
handleAction = case _ of
  SetUsername username -&gt; do
    H.modify_ _ { username = username, result = Nothing }

  MakeRequest event -&gt; do
    H.liftEffect $ Event.preventDefault event
    username &lt;- H.gets _.username
    H.modify_ _ { loading = true }
    response &lt;- H.liftAff $ AX.get AXRF.string ("https://api.github.com/users/" &lt;&gt; username)
    H.modify_ _ { loading = false, result = map _.body (hush response) }
</code></pre><p>这个例子特别有趣，因为:</p><ul><li>它混合了来自多个<code class="language-plaintext highlighter-rouge">monad</code>的函数(<code class="language-plaintext highlighter-rouge">preventDefault</code>是<code class="language-plaintext highlighter-rouge">Effect</code>，<code class="language-plaintext highlighter-rouge">AX.get</code>是<code class="language-plaintext highlighter-rouge">Aff</code>，<code class="language-plaintext highlighter-rouge">gets</code>和<code class="language-plaintext highlighter-rouge">modify_</code>是<code class="language-plaintext highlighter-rouge">HalogenM</code>)。我们可以使用<code class="language-plaintext highlighter-rouge">liftEffect</code>和<code class="language-plaintext highlighter-rouge">liftAff</code>以及我们的约束来确保一切都很好地协同工作。<li>我们只有一个约束，<code class="language-plaintext highlighter-rouge">MonadAff</code>。那是因为任何可以在<code class="language-plaintext highlighter-rouge">Effect</code>中运行的东西也可以在<code class="language-plaintext highlighter-rouge">Aff</code>中运行，所以<code class="language-plaintext highlighter-rouge">MonadAff</code>意味着 <code class="language-plaintext highlighter-rouge">MonadEffect</code>。<li>我们正在一次评估中进行多个状态更新。</ul><p>最后一点特别重要：当您修改组件呈现的状态时。这意味着在本次评估期间，我们:</p><ul><li>将<code class="language-plaintext highlighter-rouge">loading</code>设置为<code class="language-plaintext highlighter-rouge">true</code>,这会导致组件重新渲染并显示<code class="language-plaintext highlighter-rouge">Working..</code><li>将<code class="language-plaintext highlighter-rouge">loading</code>设置为<code class="language-plaintext highlighter-rouge">false</code>并更新结果，这会导致组件重新渲染并显示结果(如果有的话)。</ul><p>值得注意的是，因为我们使用的是<code class="language-plaintext highlighter-rouge">MonadAff</code>，所以我们的请求不会阻止组件做其他工作，而且我们不必处理回调来获得这种异步超能力。我们在<code class="language-plaintext highlighter-rouge">MakeRequest</code>中编写的计算只是暂停，直到我们得到响应，然后继续第二次更新状态。</p><p>仅在必要时修改状态并在可能的情况下一起批量更新是一个聪明的主意(就像我们调用<code class="language-plaintext highlighter-rouge">modify_</code>一次来更新<code class="language-plaintext highlighter-rouge">loading</code>和<code class="language-plaintext highlighter-rouge">result</code>字段一样). 这有助于确保您只在需要时重新渲染。</p><h3 id="重新审视事件处理">重新审视事件处理 <a href="#重新审视事件处理" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p>在这个例子中发生了很多事情，所以值得花点时间关注它引入的新事件处理特性。与按钮示例的简单点击处理程序不同, 此处定义的处理程序确实使用了它们所提供的事件数据:</p><ul><li>用户名输入的值由<code class="language-plaintext highlighter-rouge">onValueInput</code>处理程序(<code class="language-plaintext highlighter-rouge">SetUsername</code>操作)使用。<li>在<code class="language-plaintext highlighter-rouge">onSubmit</code>处理程序(<code class="language-plaintext highlighter-rouge">MakeRequest</code>操作)中的事件上调用<code class="language-plaintext highlighter-rouge">preventDefault</code>。</ul><p>传递给处理程序的参数类型取决于用于附加它的函数。有时，对于<code class="language-plaintext highlighter-rouge">onValueInput</code>，处理程序只是接收从事件中提取的数据 - 在这种情况下是字符串。大多数其他<code class="language-plaintext highlighter-rouge">on...</code>函数设置一个处理程序来接收整个事件，或者作为<code class="language-plaintext highlighter-rouge">Event</code>类型的值，或者作为像<code class="language-plaintext highlighter-rouge">MouseEvent</code>这样的特殊类型。详细信息可以在<a href="https://pursuit.purescript.org/packages/purescript-halogen/docs/Halogen.HTML.Events">Halogen.HTML.Events</a>的模块文档中找到；用于事件的类型和函数可以在<a href="https://pursuit.purescript.org/packages/purescript-web-events">web-events</a>和<a href="https://pursuit.purescript.org/packages/purescript-web-uievents">web-uievents</a>包中找到。</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/%E5%89%8D%E7%AB%AF-purescript-halogen/'>前端 purescript halogen</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/%E5%89%8D%E7%AB%AF-purescript-halogen/" class="post-tag no-text-decoration" >前端 purescript halogen</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Halogen-04-执行Effects - Lovelace&amp;url=/posts/Halogen-04-%E6%89%A7%E8%A1%8CEffects/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Halogen-04-执行Effects - Lovelace&amp;u=/posts/Halogen-04-%E6%89%A7%E8%A1%8CEffects/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=/posts/Halogen-04-%E6%89%A7%E8%A1%8CEffects/&amp;text=Halogen-04-执行Effects - Lovelace" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/%E5%89%8D%E7%AB%AF-purescript-halogen/">前端 purescript halogen</a> <a class="post-tag" href="/tags/eutxo%E6%A8%A1%E5%9E%8B/">eUTxO模型</a> <a class="post-tag" href="/tags/utxo%E6%A8%A1%E5%9E%8B/">UTxO模型</a> <a class="post-tag" href="/tags/%E5%88%86%E7%B1%BB%E8%B4%A6/">分类账</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Halogen-01-%E6%8C%87%E5%8D%97/"><div class="card-body"> <em class="timeago small" date="2022-01-02T11:04:00+08:00" >Jan 2, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Halogen-01-指南</h3><div class="text-muted small"><p> Halogen指南 Halogen是一个声明式的、基于组件的用于PureScript的UI库，它强调类型安全。在本指南中，您将学习在Halogen中编写实际应用程序所需的核心思想和模式。 这是一个微型Halogen应用程序，可让您递增和递减计数器: module Main where import Prelude import Effect (Effect) import Halo...</p></div></div></a></div><div class="card"> <a href="/posts/Halogen-02-%E6%B8%B2%E6%9F%93HalogenHTML/"><div class="card-body"> <em class="timeago small" date="2022-01-02T11:04:00+08:00" >Jan 2, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Halogen-02-渲染HalogenHTML</h3><div class="text-muted small"><p> 渲染Halogen HTML Halogen HTML元素是Halogen应用程序的最小构建块。这些元素描述了您希望在屏幕上看到的内容。 Halogen HTML元素不是组件（我们将在下一章中介绍组件），如果没有组件，元素就无法呈现。但是，编写生成Halogen HTML的辅助函数然后在组件中使用这些函数是很常见的。 在本章中，我们将探索在没有组件或事件的情况下编写HTML。 Halo...</p></div></div></a></div><div class="card"> <a href="/posts/Halogen-03-%E7%BB%84%E4%BB%B6/"><div class="card-body"> <em class="timeago small" date="2022-01-02T11:04:00+08:00" >Jan 2, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Halogen-03-组件</h3><div class="text-muted small"><p> 组件介绍 Halogen HTML是Halogen应用程序的基本构建块之一。但是，生成HTML的纯函数缺少实际应用程序所需的许多基本功能: 表示随时间变化的值的状态、对网络请求等事物的effects以及响应DOM事件的能力(例如，当用户单击按钮时). Halogen组件接受input并生成Halogen HTML, 就像我们目前看到的函数一样。然而, 与函数不同的是，组件维护内部状态，可...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Halogen-03-%E7%BB%84%E4%BB%B6/" class="btn btn-outline-primary" prompt="Older"><p>Halogen-03-组件</p></a> <a href="/posts/Halogen-05-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%92%8C%E8%AE%A2%E9%98%85/" class="btn btn-outline-primary" prompt="Newer"><p>Halogen-05-生命周期和订阅</p></a></div><script src="https://utteranc.es/client.js" repo="haskell-monad/haskell-monad.github.io" issue-term="title" crossorigin="anonymous" async> </script> <script type="text/javascript"> $(function() { const origin = "https://utteranc.es"; const iframe = "iframe.utterances-frame"; const lightTheme = "github-light"; const darkTheme = "github-dark"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } addEventListener("message", (event) => { let theme; /* credit to <https://github.com/utterance/utterances/issues/170#issuecomment-594036347> */ if (event.origin === origin) { /* page initial */ theme = initTheme; } else if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); } else { return; } const message = { type: "set-theme", theme: theme }; const utterances = document.querySelector(iframe).contentWindow; utterances.postMessage(message, origin); }); }); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/haskell-monad">luna</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/%E5%89%8D%E7%AB%AF-purescript-halogen/">前端 purescript halogen</a> <a class="post-tag" href="/tags/eutxo%E6%A8%A1%E5%9E%8B/">eUTxO模型</a> <a class="post-tag" href="/tags/utxo%E6%A8%A1%E5%9E%8B/">UTxO模型</a> <a class="post-tag" href="/tags/%E5%88%86%E7%B1%BB%E8%B4%A6/">分类账</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-YJYEMD99ZB"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-YJYEMD99ZB'); }); </script>
